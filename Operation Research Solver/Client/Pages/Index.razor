@page "/"
@using Shared.Models
@using Microsoft.AspNetCore.Components.Forms
@inject HttpClient Http
@inject IJSRuntime JS
@using Shared.Models

<div class="container mx-auto px-4 py-8 max-w-6xl">
    <!-- Header Section -->
    <header class="text-center mb-12">
        <h1 class="text-4xl font-bold text-blue-800 mb-2">Linear Programming Solver</h1>
        <p class="text-lg text-gray-600 max-w-3xl mx-auto">
            Upload your LP/IP model file, select an algorithm, and get optimized solutions with sensitivity analysis.
        </p>
    </header>

    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <!-- Tabs Navigation -->
        <div class="flex border-b border-gray-200">
            <button class="tab-btn py-4 px-6 font-medium text-gray-500 hover:text-blue-600 focus:outline-none border-b-2 border-transparent hover:border-blue-300 active" data-tab="upload">
                <i class="fas fa-upload mr-2"></i>Model Upload
            </button>
            <button class="tab-btn py-4 px-6 font-medium text-gray-500 hover:text-blue-600 focus:outline-none border-b-2 border-transparent hover:border-blue-300" data-tab="solve">
                <i class="fas fa-calculator mr-2"></i>Solve Model
            </button>
            <button class="tab-btn py-4 px-6 font-medium text-gray-500 hover:text-blue-600 focus:outline-none border-b-2 border-transparent hover:border-blue-300" data-tab="analysis">
                <i class="fas fa-chart-line mr-2"></i>Sensitivity Analysis
            </button>
        </div>

        <!-- Tab Contents -->
        <div class="p-6">
            <!-- Upload Tab -->
            <div id="upload" class="tab-content active">
                <div class="mb-8">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Upload Your Model</h2>
                    <p class="text-gray-600 mb-6">
                        Upload a .txt file containing your LP/IP model in the specified format. See example below.
                    </p>

                    <div class="flex flex-col md:flex-row gap-8">
                        <div class="flex-1">
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                                <label for="modelFile" class="file-input-label cursor-pointer">
                                    <div class="flex flex-col items-center justify-center">
                                        <i class="fas fa-cloud-upload-alt text-5xl text-blue-500 mb-4"></i>
                                        <h3 class="text-lg font-medium text-gray-700 mb-2">Click to upload or drag and drop</h3>
                                        <p class="text-sm text-gray-500 mb-4">.txt files only</p>
                                        <span class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">Select File</span>
                                    </div>
                                    <!-- Hidden input stays visually identical; now Blazor can read the file -->
                                    <InputFile id="modelFile" class="hidden" accept=".txt" OnChange="HandleFile" />
                                </label>
                            </div>
                            <div id="fileInfo" class="mt-4 text-sm text-gray-600 hidden">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                <span id="fileName">example.txt</span> selected
                            </div>
                        </div>

                        @* example block *@
                        <div class="flex-1">
                            <h3 class="text-lg font-medium text-gray-800 mb-3">File Format Example</h3>
                            <div class="bg-gray-100 p-4 rounded-lg font-mono text-sm">
                                <div class="text-blue-600 font-semibold mb-1"># Objective function (max/min and coefficients)</div>
                                <div class="ml-4 mb-3">max +2 +3 +3 +5 +2 +4</div>

                                <div class="text-blue-600 font-semibold mb-1"># Constraints (one per line)</div>
                                <div class="ml-4 mb-3">+11 +8 +6 +14 +10 +10 &lt;= 40</div>
                                <div class="ml-4 mb-3">+5 +2 +9 +0 +7 +3 &lt;= 25 <span class="text-gray-500 ml-2"># Optional additional constraints</span></div>

                                <div class="text-blue-600 font-semibold mb-1"># Variable restrictions (last line)</div>
                                <div class="ml-4">bin bin bin bin bin bin</div>
                            </div>

                            <div class="mt-4 text-sm text-gray-600">
                                <p class="mb-2"><span class="font-medium">Format Rules:</span></p>
                                <ul class="list-disc pl-5 space-y-1">
                                    <li>First line: Problem type (<code>max</code>/<code>min</code>) and objective coefficients</li>
                                    <li>Middle lines: Constraints (coefficients, operator <code> &lt;=</code> <code>=</code> <code>&gt;=</code>, RHS)</li>
                                    <li>Last line: Variable restrictions (<code>+</code>, <code>-</code>, <code>int</code>, <code>bin</code>, <code>urs</code>)</li>
                                    <li>Separate all values with spaces</li>
                                    <li>Comments can be added with <code>#</code></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="filePreviewSection" class="hidden">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">File Preview</h3>
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <pre id="filePreview" class="text-sm">@(_modelText)</pre>
                    </div>
                </div>
            </div>

            <!-- Solve Tab -->
            <div id="solve" class="tab-content">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Solve Model</h2>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="md:col-span-2">
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <h3 class="text-lg font-medium text-gray-800 mb-3">Model Summary</h3>
                            <div id="modelSummary" class="text-sm text-gray-700">
                                No model loaded. Please upload a file in the Upload section.
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <h3 class="text-lg font-medium text-gray-800 mb-3">Algorithm Selection</h3>
                            <div class="mb-4">
                                <label for="algorithm" class="block text-sm font-medium text-gray-700 mb-1">Choose solving method:</label>
                                <InputSelect id="algorithm"
                                             class="w-full border rounded px-2 py-1"
                                             @bind-Value="request.Algorithm"
                                             TValue="Algorithm">
                                    <option value="@Algorithm.PrimalSimplex">Primal Simplex</option>
                                    <option value="@Algorithm.RevisedSimplex">Revised Simplex</option>
                                    <option value="@Algorithm.BranchAndBound">Branch &amp; Bound</option>
                                    <option value="@Algorithm.Knapsack01">0–1 Knapsack</option>
                                    <option value="@Algorithm.CuttingPlane">Cutting Plane (Gomory)</option>
                                </InputSelect>
                            </div>
                            <button id="runSolverBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition flex items-center justify-center"
                                    @onclick="RunSolver">
                                <i class="fas fa-play-circle mr-2"></i> Run Solver
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mb-8">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">Solution Output</h3>
                    <div class="output-container bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <div id="solverOutput" class="text-sm font-mono">
                            @if (string.IsNullOrWhiteSpace(_output))
                            {
                                <p class="text-gray-500 italic">Solution output will appear here after running the solver.</p>
                            }
                            else
                            {
                                <pre>@_output</pre>
                            }
                        </div>
                    </div>
                </div>

                <div class="flex flex-wrap gap-3">
                    <button id="downloadResultsBtn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md transition flex items-center disabled:opacity-50"
                            @onclick="DownloadResults" disabled="@string.IsNullOrWhiteSpace(_output)">
                        <i class="fas fa-file-download mr-2"></i> Download Results
                    </button>
                    <button id="resetSolverBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-md transition flex items-center"
                            @onclick="ResetSolver">
                        <i class="fas fa-redo mr-2"></i> Reset
                    </button>
                </div>
            </div>

            <!-- Analysis Tab -->
            <div id="analysis" class="tab-content">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Sensitivity Analysis</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6">
                            <h3 class="text-lg font-medium text-gray-800 mb-3">Current Solution</h3>
                            <div id="currentSolution" class="text-sm">
                                @if (string.IsNullOrWhiteSpace(_solutionSummary))
                                {
                                    <p class="text-gray-500 italic">No solution available yet. Please solve a model first.</p>
                                }
                                else
                                {
                                    <p>@_solutionSummary</p>
                                }
                            </div>
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <h3 class="text-lg font-medium text-gray-800 mb-3">Sensitivity Tools</h3>
                            <p class="text-sm text-gray-600 mb-4">Perform additional analysis on the solved model:</p>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                <!-- (buttons unchanged; JS handles clicks/alerts if you use it later) -->
                                <button class="sensitivity-btn bg-purple-100 hover:bg-purple-200 text-purple-800 font-medium py-2 px-3 rounded-md text-sm flex items-center" data-analysis="range-nonbasic">
                                    <i class="fas fa-ruler-horizontal mr-2"></i> Range of Non-Basic Var
                                </button>
                                <button class="sensitivity-btn bg-purple-100 hover:bg-purple-200 text-purple-800 font-medium py-2 px-3 rounded-md text-sm flex items-center" data-analysis="change-nonbasic">
                                    <i class="fas fa-exchange-alt mr-2"></i> Change Non-Basic Var
                                </button>
                                <button class="sensitivity-btn bg-purple-100 hover:bg-purple-200 text-purple-800 font-medium py-2 px-3 rounded-md text-sm flex items-center" data-analysis="range-basic">
                                    <i class="fas fa-ruler-combined mr-2"></i> Range of Basic Var
                                </button>
                                <button class="sensitivity-btn bg-purple-100 hover:bg-purple-200 text-purple-800 font-medium py-2 px-3 rounded-md text-sm flex items-center" data-analysis="change-basic">
                                    <i class="fas fa-random mr-2"></i> Change Basic Var
                                </button>
                                <button class="sensitivity-btn bg-purple-100 hover:bg-purple-200 text-purple-800 font-medium py-2 px-3 rounded-md text-sm flex items-center"
                                        @onclick='() => CallSensitivity("rhs-ranges")'>
                                    <i class="fas fa-ruler-vertical mr-2"></i> Range of RHS
                                </button>

                                <button class="sensitivity-btn bg-purple-100 hover:bg-purple-200 text-purple-800 font-medium py-2 px-3 rounded-md text-sm flex items-center" data-analysis="change-rhs">
                                    <i class="fas fa-retweet mr-2"></i> Change RHS Value
                                </button>
                                <button class="sensitivity-btn bg-purple-100 hover:bg-purple-200 text-purple-800 font-medium py-2 px-3 rounded-md text-sm flex items-center" data-analysis="range-nonbasic-col">
                                    <i class="fas fa-columns mr-2"></i> Range in Non-Basic Col
                                </button>
                                <button class="sensitivity-btn bg-purple-100 hover:bg-purple-200 text-purple-800 font-medium py-2 px-3 rounded-md text-sm flex items-center" data-analysis="change-nonbasic-col">
                                    <i class="fas fa-edit mr-2"></i> Change in Non-Basic Col
                                </button>
                                <button class="sensitivity-btn bg-purple-100 hover:bg-purple-200 text-purple-800 font-medium py-2 px-3 rounded-md text-sm flex items-center" data-analysis="add-activity">
                                    <i class="fas fa-plus-square mr-2"></i> Add New Activity
                                </button>
                                <button class="sensitivity-btn bg-purple-100 hover:bg-purple-200 text-purple-800 font-medium py-2 px-3 rounded-md text-sm flex items-center" data-analysis="add-constraint">
                                    <i class="fas fa-plus-circle mr-2"></i> Add Constraint
                                </button>
                                <button class="sensitivity-btn bg-purple-100 hover:bg-purple-200 text-purple-800 font-medium py-2 px-3 rounded-md text-sm flex items-center" data-analysis="shadow-prices">
                                    <i class="fas fa-project-diagram mr-2" @onclick='() => CallSensitivity("shadow-prices")'></i> Shadow Prices
                                </button>
                                <button class="sensitivity-btn bg-purple-100 hover:bg-purple-200 text-purple-800 font-medium py-2 px-3 rounded-md text-sm flex items-center" data-analysis="apply-duality">
                                    <i class="fas fa-code-branch mr-2"></i> Apply Duality
                                </button>
                                <button class="sensitivity-btn bg-purple-100 hover:bg-purple-200 text-purple-800 font-medium py-2 px-3 rounded-md text-sm flex items-center" data-analysis="solve-dual">
                                    <i class="fas fa-arrows-alt-h mr-2"></i> Solve Dual Model
                                </button>
                                <button class="sensitivity-btn bg-purple-100 hover:bg-purple-200 text-purple-800 font-medium py-2 px-3 rounded-md text-sm flex items-center" data-analysis="verify-duality">
                                    <i class="fas fa-check-double mr-2"></i> Verify Duality
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-6">
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <h3 class="text-lg font-medium text-gray-800 mb-3">Analysis Results</h3>
                            <div id="sensitivityOutput" class="output-container text-sm font-mono">
                                <p class="text-gray-500 italic">Sensitivity analysis results will appear here.</p>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <h3 class="text-lg font-medium text-gray-800 mb-3">Graphical Analysis</h3>
                            <canvas id="sensitivityChart" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-12 text-center text-gray-500 text-sm">
        <p>Linear Programming Solver &copy; 2025 | Created for Operations Research</p>
    </footer>
</div>

@code {
    // model text populated by either the Blazor file read OR your existing JS preview
    private string _modelText = "";
    private string _output = "";
    private string _solutionSummary = "";

    private SolveRequest request = new()
        {
            Algorithm = Algorithm.PrimalSimplex,
            Settings = new SolveSettings
            {
                Verbose = true,
                TimeLimitSeconds = 60,
                MaxIterations = 5000
            }
        };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("initializeApp");
        }
    }

    //Tom add
    private async Task CallSensitivity(string endpoint)
    {
        try
        {
            var resp = await Http.GetAsync($"api/sensitivity/{endpoint}");
            var raw = await resp.Content.ReadAsStringAsync();

            string display;
            if (resp.IsSuccessStatusCode &&
                !string.IsNullOrWhiteSpace(raw) &&
                (raw.TrimStart().StartsWith("{") || raw.TrimStart().StartsWith("[")))
            {
                using var doc = System.Text.Json.JsonDocument.Parse(raw);
                display = System.Text.Json.JsonSerializer.Serialize(
                    doc,
                    new System.Text.Json.JsonSerializerOptions { WriteIndented = true }
                );
            }
            else
            {
                display = string.IsNullOrWhiteSpace(raw)
                    ? $"{(int)resp.StatusCode} {resp.ReasonPhrase}"
                    : raw;
            }

            await JS.InvokeVoidAsync("renderSensitivity", display);
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("renderSensitivity", $"Error calling API: {ex.Message}");
        }
    }




    // Capture uploaded file content (no visual change; input stays hidden)
    private async Task HandleFile(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file is null) return;

        using var stream = file.OpenReadStream(2 * 1024 * 1024);
        using var reader = new StreamReader(stream);
        _modelText = await reader.ReadToEndAsync();

        // Keep SolveRequest in sync for the API
        request.ModelText = _modelText;

        StateHasChanged();
    }

    private async Task RunSolver()
    {
        // Fallback: if Blazor didn't read, try to grab JS preview text
        if (string.IsNullOrWhiteSpace(request.ModelText))
        {
            try
            {
                var txt = await JS.InvokeAsync<string>("eval", "document.getElementById('filePreview')?.textContent || ''");
                request.ModelText = txt ?? "";
            }
            catch { /* ignore */ }
        }

        if (string.IsNullOrWhiteSpace(request.ModelText))
        {
            await JS.InvokeVoidAsync("showAlert", "Please upload a model first.", "warning");
            return;
        }

        _output = "Solving...";
        StateHasChanged();

        try
        {
            var resp = await Http.PostAsJsonAsync("api/solve", request);
            if (!resp.IsSuccessStatusCode)
            {
                var err = await resp.Content.ReadAsStringAsync();
                _output = $"Server error ({(int)resp.StatusCode}): {err}";
                _solutionSummary = "";
                StateHasChanged();
                return;
            }

            var body = await resp.Content.ReadFromJsonAsync<SolveResponse>();
            _output = body?.OutputText ?? "(no output)";
            _solutionSummary = body?.SolutionSummary ?? "";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            _output = $"Error calling solver: {ex.Message}";
            _solutionSummary = "";
            StateHasChanged();
        }
    }

    private void ResetSolver()
    {
        _modelText = "";
        request.ModelText = "";
        _output = "";
        _solutionSummary = "";
    }

    private async Task DownloadResults()
    {
        if (string.IsNullOrWhiteSpace(_output))
        {
            await JS.InvokeVoidAsync("showAlert", "No results to download.", "warning");
            return;
        }

        // Use a small JS helper (you already have download.js)
        var bytes = System.Text.Encoding.UTF8.GetBytes(_output);
        var b64 = Convert.ToBase64String(bytes);
        await JS.InvokeVoidAsync("downloadFile", "lp_solution.txt", "text/plain", b64);
    }
}
